#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace webignition\BasilRunner\Bin;

require 'vendor/autoload.php';

use Socket\Raw\Factory;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Console\Input\InputDefinition;
use Symfony\Component\Console\Input\InputOption;

$input = new ArgvInput(
    $argv,
    new InputDefinition([
        new InputOption(
            'compiler',
            null,
            InputOption::VALUE_REQUIRED,
            '',
            './compiler.phar'
        )
    ])
);

$compiler = (string) $input->getOption('compiler');

$factory = new Factory();
$listenSocket = $factory->createServer('tcp://localhost:10000');

do {
    $communicationSocket = $listenSocket->accept();

    do {
        $buffer = $communicationSocket->read(2048);
        $buffer = trim($buffer);

        if ('' === $buffer) {
            continue;
        }

        if ($buffer == 'quit') {
            break;
        }

        $command = $compiler . ' ' . $buffer;
        $commandOutput = [];
        $commandExitCode = null;

        exec($command, $commandOutput, $commandExitCode);

        $communicationSocket->write((string) $commandExitCode . "\n");
        $communicationSocket->write(implode("\n", $commandOutput) . "\n");
    } while (true);
    $communicationSocket->shutdown();
    $communicationSocket->close();
} while (true);

$listenSocket->close();
